<!-- HEADER MANUAL -->
<ion-header class="ion-no-border">
  <ion-toolbar class="header-toolbar">
    <div class="header-container">
      <!-- Logo -->
      <div class="header-logo">
        <img src="assets/icon/Escudo_PUCV-2016__Perfil Redes TW_FB.png" alt="PUCV Logo" />
        <span class="header-logo-text">MarketPlace</span>
      </div>

      <!-- Navegación -->
      <nav class="header-nav">
        <a routerLink="/home" routerLinkActive="nav-link--active" class="nav-link">Inicio</a>
        <a routerLink="/categorias" routerLinkActive="nav-link--active" class="nav-link">Categorías</a>
        <a routerLink="/carrito" routerLinkActive="nav-link--active" class="nav-link">
          <ion-icon name="cart-outline"></ion-icon>
          Carrito
        </a>
      </nav>

      <!-- Botones de autenticación -->
      <div class="header-actions">
        <!-- Mostrar cuando NO está logueado -->
        <ng-container *ngIf="!authService.isLoggedIn()">
          <ion-button routerLink="/auth" fill="clear" class="btn-auth btn-login">
            <ion-icon slot="start" name="log-in-outline"></ion-icon>
            Iniciar Sesión
          </ion-button>
          <ion-button routerLink="/auth" fill="solid" class="btn-auth btn-register">
            Registrarse
          </ion-button>
        </ng-container>

        <!-- Mostrar cuando SÍ está logueado -->
        <ng-container *ngIf="authService.isLoggedIn()">
          <ion-button routerLink="/publicar" fill="solid" class="btn-auth btn-publicar">
            <ion-icon slot="start" name="add-outline"></ion-icon>
            Publicar
          </ion-button>
          
          <ion-button routerLink="/perfil" fill="solid" class="btn-auth btn-perfil">
            <ion-icon slot="start" name="person-outline"></ion-icon>
            Perfil
          </ion-button>
          
          <ion-button (click)="authService.logout()" fill="solid" class="btn-auth btn-logout">
          <ion-icon slot="start" name="log-out-outline"></ion-icon>
        Cerrar Sesión
        </ion-button>
        </ng-container>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- ==================================== -->
  <!-- SEGMENTO: INFORMACIÓN DEL PERFIL -->
  <!-- ==================================== -->
  <div *ngIf="selectedSegment === 'info'">
    <!-- MODO VISUALIZACIÓN -->
    <div *ngIf="!editMode" class="perfil-wrapper">
      <!-- Header Card -->
      <div class="perfil-header-card">
        <img src="assets/avatar/4794936.png" class="avatar-large" alt="Avatar" />
        <div class="perfil-nombre">{{ user.nombre || 'Sin nombre' }}</div>
        <div class="perfil-rol">Estudiante</div>
        <div class="perfil-status">Activo</div>
        <div class="perfil-carrera">{{ user.carrera || 'Ingeniería en Informática' }}</div>
      </div>

      <!-- Info Card -->
      <ion-card class="info-card">
        <ion-card-content>
          <div class="info-row">
            <span class="label">Correo:</span>
            <span class="value">{{ user.correo || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Usuario:</span>
            <span class="value">{{ user.usuario || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">RUT:</span>
            <span class="value">{{ user.rut || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Región:</span>
            <span class="value">{{ user.region || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Comuna:</span>
            <span class="value">{{ user.comuna || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Género:</span>
            <span class="value">{{ user.genero || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Fecha Nacimiento:</span>
            <span class="value">{{ user.fecha_nacimiento || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Teléfono 1:</span>
            <span class="value">{{ user.telefono1 || 'No especificado' }}</span>
          </div>

          <div class="info-row" *ngIf="user.telefono2">
            <span class="label">Teléfono 2:</span>
            <span class="value">{{ user.telefono2 }}</span>
          </div>

          <div class="info-row" *ngIf="user.direccion">
            <span class="label">Dirección:</span>
            <span class="value">{{ user.direccion }}</span>
          </div>

          <div class="info-row">
            <span class="label">Miembro desde:</span>
            <span class="value">{{ user.fecha_creacion | date:'dd/MM/yyyy' }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button expand="block" class="edit-btn" (click)="activarModoEdicion()">
        <ion-icon slot="start" name="create-outline"></ion-icon>
        Editar Perfil
      </ion-button>
    </div>

    <!-- MODO EDICIÓN -->
    <!-- MODO EDICIÓN -->
<div *ngIf="editMode" class="edicion-container">
  <div class="edicion-card">
    <!-- Header del formulario -->
    <div class="edicion-header">
      <h2>
        <ion-icon name="create-outline"></ion-icon>
        Editar Perfil
      </h2>
      <p>Actualiza tu información personal</p>
    </div>

    <!-- Body del formulario -->
    <div class="edicion-body">
      
      <!-- Sección: Información Personal -->
      <div class="form-section">
        <h3 class="section-title">
          <ion-icon name="person-outline"></ion-icon>
          Información Personal
        </h3>
        
        <div class="form-item">
          <ion-label>Nombre Completo *</ion-label>
          <ion-input [(ngModel)]="user.nombre" placeholder="Ingresa tu nombre completo"></ion-input>
        </div>

        <div class="form-item">
          <ion-label>RUT</ion-label>
          <ion-input [(ngModel)]="user.rut" placeholder="12345678-9"></ion-input>
        </div>

        <div class="form-row">
          <div class="form-item">
            <ion-label>Género</ion-label>
            <ion-select [(ngModel)]="user.genero" placeholder="Selecciona">
              <ion-select-option value="masculino">Masculino</ion-select-option>
              <ion-select-option value="femenino">Femenino</ion-select-option>
              <ion-select-option value="otro">Otro</ion-select-option>
            </ion-select>
          </div>

          <div class="form-item">
            <ion-label>Fecha de Nacimiento</ion-label>
            <ion-input type="date" [(ngModel)]="user.fecha_nacimiento"></ion-input>
          </div>
        </div>
      </div>

      <!-- Sección: Ubicación -->
      <div class="form-section">
        <h3 class="section-title">
          <ion-icon name="location-outline"></ion-icon>
          Ubicación
        </h3>

        <div class="form-row">
          <div class="form-item">
            <ion-label>Región</ion-label>
            <ion-input [(ngModel)]="user.region" placeholder="Ej: Valparaíso"></ion-input>
          </div>

          <div class="form-item">
            <ion-label>Comuna</ion-label>
            <ion-input [(ngModel)]="user.comuna" placeholder="Ej: Viña del Mar"></ion-input>
          </div>
        </div>

        <div class="form-item">
          <ion-label>Dirección</ion-label>
          <ion-textarea [(ngModel)]="user.direccion" placeholder="Calle, número, depto"></ion-textarea>
        </div>
      </div>

      <!-- Sección: Contacto -->
      <div class="form-section">
        <h3 class="section-title">
          <ion-icon name="call-outline"></ion-icon>
          Información de Contacto
        </h3>

        <div class="form-row">
          <div class="form-item">
            <ion-label>Teléfono Principal</ion-label>
            <ion-input type="tel" [(ngModel)]="user.telefono1" placeholder="+56 9 1234 5678"></ion-input>
          </div>

          <div class="form-item">
            <ion-label>Teléfono Secundario</ion-label>
            <ion-input type="tel" [(ngModel)]="user.telefono2" placeholder="+56 9 8765 4321"></ion-input>
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="botones-edicion">
        <ion-button expand="block" (click)="guardarCambios()" class="btn-guardar">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          Guardar Cambios
        </ion-button>
        
        <ion-button expand="block" fill="outline" (click)="cancelarEdicion()" class="btn-cancelar">
          <ion-icon name="close-circle-outline"></ion-icon>
          Cancelar
        </ion-button>
      </div>

    </div>
  </div>
</div>

    <!-- Lista de pedidos -->
    <div *ngIf="pedidos.length > 0" class="pedidos-container">
      <ion-card *ngFor="let pedido of pedidos" class="pedido-card">
        <ion-card-header>
          <div class="pedido-header">
            <div>
              <ion-card-title>Pedido #{{ pedido.id }}</ion-card-title>
              <ion-card-subtitle>
                <ion-icon name="time-outline"></ion-icon>
                {{ formatearFecha(pedido.created_at) }}
              </ion-card-subtitle>
            </div>
            <ion-badge [color]="getEstadoBadgeColor(pedido.estado)">
              {{ pedido.estado }}
            </ion-badge>
          </div>
        </ion-card-header>

        <ion-card-content>
          <ion-list lines="none">
            <ion-item>
              <ion-icon name="card-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Total</h3>
                <p>${{ pedido.total | number }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="receipt-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Método de Pago</h3>
                <p>{{ pedido.metodo_pago || 'No especificado' }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Dirección de Entrega</h3>
                <p>{{ pedido.direccion_entrega || 'Por coordinar' }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="cube-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Productos</h3>
                <p>{{ pedido.cantidad_items }} item(s)</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Loading -->
    <div *ngIf="loadingPedidos" class="loading-pedidos">
      <ion-spinner></ion-spinner>
      <p>Cargando pedidos...</p>
    </div>
  </div>
</ion-content>
