<ion-header class="topbar">
  <div class="navbar">
    <!-- LEFT -->
    <div class="nav-left">
      <img src="assets/logo-pucv.png" class="logo" alt="Logo PUCV" />
      <span class="brand">Marketplace PUCV</span>
    </div>

    <!-- CENTER -->
    <div class="nav-center">
      <a routerLink="/home">Inicio</a>
      <a routerLink="/productos">Productos</a>
      <a routerLink="/perfil" class="active">Perfil</a>
    </div>

    <!-- RIGHT -->
    <div class="nav-right">
      <ion-button *ngIf="!authService.isLoggedIn()" routerLink="/auth" color="light">
        Iniciar Sesión
      </ion-button>
      <ion-button *ngIf="authService.isLoggedIn()" routerLink="/publicar-producto" color="primary">
        Publicar
      </ion-button>
      <ion-button *ngIf="authService.isLoggedIn()" (click)="authService.logout()" color="danger">
        Cerrar Sesión
      </ion-button>
    </div>
  </div>

  <!-- SEGMENTO -->
  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChange($event)">
      <ion-segment-button value="info">
        <ion-label>Información</ion-label>
      </ion-segment-button>
      <ion-segment-button value="pedidos">
        <ion-label>Mis Pedidos</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- ==================================== -->
  <!-- SEGMENTO: INFORMACIÓN DEL PERFIL -->
  <!-- ==================================== -->
  <div *ngIf="selectedSegment === 'info'">
    <!-- MODO VISUALIZACIÓN -->
    <div *ngIf="!editMode" class="perfil-wrapper">
      <!-- Header Card -->
      <div class="perfil-header-card">
        <img src="assets/avatar/4794936.png" class="avatar-large" alt="Avatar" />
        <div class="perfil-nombre">{{ user.nombre || 'Sin nombre' }}</div>
        <div class="perfil-rol">Estudiante</div>
        <div class="perfil-status">Activo</div>
        <div class="perfil-carrera">{{ user.carrera || 'Ingeniería en Informática' }}</div>
      </div>

      <!-- Info Card -->
      <ion-card class="info-card">
        <ion-card-content>
          <div class="info-row">
            <span class="label">Correo:</span>
            <span class="value">{{ user.correo || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Usuario:</span>
            <span class="value">{{ user.usuario || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">RUT:</span>
            <span class="value">{{ user.rut || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Región:</span>
            <span class="value">{{ user.region || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Comuna:</span>
            <span class="value">{{ user.comuna || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Género:</span>
            <span class="value">{{ user.genero || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Fecha Nacimiento:</span>
            <span class="value">{{ user.fecha_nacimiento || 'No especificado' }}</span>
          </div>

          <div class="info-row">
            <span class="label">Teléfono 1:</span>
            <span class="value">{{ user.telefono1 || 'No especificado' }}</span>
          </div>

          <div class="info-row" *ngIf="user.telefono2">
            <span class="label">Teléfono 2:</span>
            <span class="value">{{ user.telefono2 }}</span>
          </div>

          <div class="info-row" *ngIf="user.direccion">
            <span class="label">Dirección:</span>
            <span class="value">{{ user.direccion }}</span>
          </div>

          <div class="info-row">
            <span class="label">Miembro desde:</span>
            <span class="value">{{ user.fecha_creacion | date:'dd/MM/yyyy' }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button expand="block" class="edit-btn" (click)="activarModoEdicion()">
        <ion-icon slot="start" name="create-outline"></ion-icon>
        Editar Perfil
      </ion-button>
    </div>

    <!-- MODO EDICIÓN -->
    <div *ngIf="editMode" class="edicion-container">
      <ion-card>
        <ion-card-header>
          <ion-card-title>Editar Perfil</ion-card-title>
          <ion-card-subtitle>Actualiza tu información personal</ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>
          <form (ngSubmit)="guardarCambios()">
            <ion-item>
              <ion-label position="floating">Nombre Completo *</ion-label>
              <ion-input type="text" [(ngModel)]="user.nombre" name="nombre" required></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">RUT</ion-label>
              <ion-input type="text" [(ngModel)]="user.rut" name="rut"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Región</ion-label>
              <ion-select [(ngModel)]="user.region" name="region">
                <ion-select-option value="Valparaíso">Valparaíso</ion-select-option>
                <ion-select-option value="Metropolitana">Metropolitana</ion-select-option>
                <ion-select-option value="Biobío">Biobío</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Comuna</ion-label>
              <ion-input type="text" [(ngModel)]="user.comuna" name="comuna"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Género</ion-label>
              <ion-select [(ngModel)]="user.genero" name="genero">
                <ion-select-option value="masculino">Masculino</ion-select-option>
                <ion-select-option value="femenino">Femenino</ion-select-option>
                <ion-select-option value="otro">Otro</ion-select-option>
                <ion-select-option value="prefiero_no_decir">Prefiero no decir</ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Fecha de Nacimiento</ion-label>
              <ion-input type="date" [(ngModel)]="user.fecha_nacimiento" name="fecha_nacimiento"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Teléfono Principal</ion-label>
              <ion-input type="tel" [(ngModel)]="user.telefono1" name="telefono1"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Teléfono Secundario</ion-label>
              <ion-input type="tel" [(ngModel)]="user.telefono2" name="telefono2"></ion-input>
            </ion-item>

            <ion-item>
              <ion-label position="floating">Dirección</ion-label>
              <ion-textarea [(ngModel)]="user.direccion" name="direccion" rows="2"></ion-textarea>
            </ion-item>

            <div class="botones-edicion">
              <ion-button expand="block" type="submit" color="success">
                <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
                Guardar Cambios
              </ion-button>

              <ion-button expand="block" fill="outline" color="medium" (click)="cancelarEdicion()">
                <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                Cancelar
              </ion-button>
            </div>
          </form>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- ==================================== -->
  <!-- SEGMENTO: MIS PEDIDOS -->
  <!-- ==================================== -->
  <div *ngIf="selectedSegment === 'pedidos'">
    <!-- Sin pedidos -->
    <div *ngIf="pedidos.length === 0 && !loadingPedidos" class="sin-pedidos">
      <ion-icon name="receipt-outline" size="large" color="medium"></ion-icon>
      <h2>No tienes pedidos</h2>
      <p>Tus compras aparecerán aquí</p>
      <ion-button routerLink="/home" color="primary">
        <ion-icon slot="start" name="cart-outline"></ion-icon>
        Explorar Productos
      </ion-button>
    </div>

    <!-- Lista de pedidos -->
    <div *ngIf="pedidos.length > 0" class="pedidos-container">
      <ion-card *ngFor="let pedido of pedidos" class="pedido-card">
        <ion-card-header>
          <div class="pedido-header">
            <div>
              <ion-card-title>Pedido #{{ pedido.id }}</ion-card-title>
              <ion-card-subtitle>
                <ion-icon name="time-outline"></ion-icon>
                {{ formatearFecha(pedido.created_at) }}
              </ion-card-subtitle>
            </div>
            <ion-badge [color]="getEstadoBadgeColor(pedido.estado)">
              {{ pedido.estado }}
            </ion-badge>
          </div>
        </ion-card-header>

        <ion-card-content>
          <ion-list lines="none">
            <ion-item>
              <ion-icon name="card-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Total</h3>
                <p>${{ pedido.total | number }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="receipt-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Método de Pago</h3>
                <p>{{ pedido.metodo_pago || 'No especificado' }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="location-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Dirección de Entrega</h3>
                <p>{{ pedido.direccion_entrega || 'Por coordinar' }}</p>
              </ion-label>
            </ion-item>

            <ion-item>
              <ion-icon name="cube-outline" slot="start" color="primary"></ion-icon>
              <ion-label>
                <h3>Productos</h3>
                <p>{{ pedido.cantidad_items }} item(s)</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Loading -->
    <div *ngIf="loadingPedidos" class="loading-pedidos">
      <ion-spinner></ion-spinner>
      <p>Cargando pedidos...</p>
    </div>
  </div>
</ion-content>
